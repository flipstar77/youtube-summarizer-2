{% extends "base.html" %}

{% block title %}New Summary - YouTube Summarizer{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card fade-in">
            <div class="card-header">
                <h4><i class="fas fa-magic text-primary"></i> Create New Summary</h4>
                <p class="mb-0 text-muted">Transform any YouTube video into an intelligent summary</p>
            </div>
            <div class="card-body">
                <form id="summaryForm" method="POST">
                    <div class="mb-4">
                        <label for="url" class="form-label">
                            <i class="fab fa-youtube text-danger"></i> YouTube URL
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0">
                                <i class="fas fa-link text-muted"></i>
                            </span>
                            <input type="url" class="form-control border-start-0" id="url" name="url" 
                                   placeholder="https://www.youtube.com/watch?v=dQw4w9WgXcQ" required>
                        </div>
                        <div class="form-text mt-2">
                            <i class="fas fa-info-circle"></i> Paste any YouTube video URL to get started
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="summary_type" class="form-label">
                            <i class="fas fa-list-alt text-info"></i> Summary Type
                        </label>
                        <select class="form-select" id="summary_type" name="summary_type">
                            <option value="detailed" selected>ðŸ“‹ Detailed Summary - Comprehensive analysis</option>
                            <option value="brief">âš¡ Brief Summary - Quick overview</option>
                            <option value="bullet">ðŸŽ¯ Bullet Points - Key takeaways</option>
                            <option value="tutorial">ðŸ“– Tutorial Guide - Step-by-step instructions</option>
                            <option value="professional">ðŸŽ¯ Professional Summary - Structured analysis</option>
                            <option value="custom">âœ¨ Custom Prompt - Your own instructions</option>
                        </select>
                        <div class="form-text mt-2">
                            Choose the level of detail for your summary
                        </div>
                    </div>

                    <div class="mb-4" id="customPromptSection" style="display: none;">
                        <label for="custom_prompt" class="form-label">
                            <i class="fas fa-edit text-primary"></i> Custom Prompt
                        </label>
                        <textarea class="form-control" id="custom_prompt" name="custom_prompt" rows="4" 
                                  placeholder="Enter your custom instructions for the AI...

Example:
- Summarize this in a specific format
- Focus on particular aspects
- Extract specific information
- Use a particular writing style"></textarea>
                        <div class="form-text mt-2">
                            <i class="fas fa-lightbulb text-warning"></i> 
                            Write detailed instructions for how you want the AI to process the transcript. 
                            The AI will use your instructions to create a custom summary.
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="language" class="form-label">
                            <i class="fas fa-globe text-success"></i> Preferred Language
                        </label>
                        <select class="form-select" id="language" name="language">
                            <option value="en" selected>ðŸ‡ºðŸ‡¸ English</option>
                            <option value="es">ðŸ‡ªðŸ‡¸ Spanish</option>
                            <option value="fr">ðŸ‡«ðŸ‡· French</option>
                            <option value="de">ðŸ‡©ðŸ‡ª German</option>
                            <option value="it">ðŸ‡®ðŸ‡¹ Italian</option>
                            <option value="pt">ðŸ‡µðŸ‡¹ Portuguese</option>
                            <option value="ru">ðŸ‡·ðŸ‡º Russian</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">
                            <i class="fas fa-robot text-purple"></i> AI Provider
                        </label>
                        <div class="card bg-gradient border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div class="card-body p-3 text-white">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <select class="form-select" id="ai_provider" name="ai_provider">
                                                <option value="openai" selected>ðŸ¤– OpenAI - GPT Models</option>
                                                <!-- Dynamic options will be loaded here -->
                                            </select>
                                        </div>
                                        <div class="mb-0">
                                            <select class="form-select" id="ai_model" name="ai_model">
                                                <option value="">Auto-select best model</option>
                                            </select>
                                            <small class="text-white-50 d-block mt-1">Advanced: Choose specific model (optional)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <div class="ai-status-indicator">
                                            <i class="fas fa-circle text-success" id="aiStatusIcon"></i>
                                            <div class="small" id="aiStatusText">Ready</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-lightbulb text-warning"></i> 
                            Choose your preferred AI provider. Each offers unique strengths:
                            <strong>OpenAI</strong> (balanced), <strong>Perplexity</strong> (deep research + web context), 
                            <strong>DeepSeek</strong> (reasoning), <strong>Gemini</strong> (advanced), 
                            <strong>Grok</strong> (creative), <strong>Claude</strong> (helpful)
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="max_tokens" class="form-label">
                            <i class="fas fa-sliders-h text-warning"></i> Max Output Tokens (Advanced)
                        </label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="max_tokens" name="max_tokens" 
                                   min="100" max="4000" placeholder="Auto (500-1500 based on type)">
                            <span class="input-group-text bg-light">tokens</span>
                        </div>
                        <div class="form-text mt-2">
                            <i class="fas fa-info-circle"></i> Leave empty for automatic selection. Brief: 500, Detailed: 1000, Tutorial/Professional: 1500
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="card bg-light border-0">
                            <div class="card-body p-3">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="generate_audio" name="generate_audio">
                                    <label class="form-check-label" for="generate_audio">
                                        <strong><i class="fas fa-volume-up text-primary"></i> Generate Audio Version</strong>
                                        <small class="text-muted d-block mt-1">Create a high-quality spoken version using AI voice synthesis</small>
                                    </label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="generate_srt" name="generate_srt">
                                    <label class="form-check-label" for="generate_srt">
                                        <strong><i class="fas fa-closed-captioning text-info"></i> Generate SRT Subtitles</strong>
                                        <small class="text-muted d-block mt-1">Create subtitle file for video accessibility and multi-language support</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3" id="voiceSelection" style="display: none;">
                        <label for="voice_id" class="form-label">
                            Voice Selection
                            <a href="https://try.elevenlabs.io/6qmgmbs0b5oi" target="_blank" class="badge bg-info text-decoration-none ms-2">
                                <i class="fas fa-external-link-alt"></i> Powered by ElevenLabs
                            </a>
                        </label>
                        <select class="form-select" id="voice_id" name="voice_id">
                            <!-- DEBUG: voices={{ voices|length if voices else 'None' }} timestamp={{ timestamp }} -->
                            {% if voices %}
                                <!-- DEBUG: Found {{ voices|length }} voices at {{ timestamp }} -->
                                {% for voice in voices %}
                                    <option value="{{ voice.voice_id }}">{{ voice.name }} - {{ voice.description }}</option>
                                {% endfor %}
                            {% else %}
                                <!-- DEBUG: No voices found, using fallback at {{ timestamp }} -->
                                <option value="21m00Tcm4TlvDq8ikWAM">Rachel - American female voice, calm and clear</option>
                                <option value="AZnzlk1XvdvUeBnXmlld">Domi - American female voice, confident</option>
                                <option value="EXAVITQu4vr4xnSDxMaL">Bella - American female voice, friendly</option>
                            {% endif %}
                        </select>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <i class="fas fa-magic"></i> Generate Summary
                            <small class="d-block mt-1 opacity-75">This may take 30-60 seconds</small>
                        </button>
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </a>
                    </div>
                </form>

                <div id="progressDiv" class="mt-4" style="display: none;">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6><i class="fas fa-spinner fa-spin"></i> Processing...</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="statusText">Initializing...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load available AI providers on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAIProviders();
});

function loadAIProviders() {
    fetch('/ai_providers')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                populateProviderSelect(data.providers, data.default);
            } else {
                console.warn('Could not load AI providers:', data.message);
            }
        })
        .catch(error => {
            console.warn('Error loading AI providers:', error);
        });
}

function populateProviderSelect(providers, defaultProvider) {
    const providerSelect = document.getElementById('ai_provider');
    const modelSelect = document.getElementById('ai_model');
    
    // Clear existing options
    providerSelect.innerHTML = '';
    
    // Add provider options
    const providerNames = {
        'openai': 'ðŸ¤– OpenAI - GPT Models',
        'perplexity': 'ðŸ” Perplexity - Deep Research & Web Context',
        'deepseek': 'ðŸ§  DeepSeek - Advanced Reasoning',
        'gemini': 'ðŸ’Ž Google Gemini - Latest AI',
        'grok': 'âš¡ Grok - xAI\'s Creative Model',
        'claude': 'ðŸŽ­ Claude - Anthropic AI'
    };
    
    Object.keys(providers).forEach(provider => {
        const option = document.createElement('option');
        option.value = provider;
        option.textContent = providerNames[provider] || `${provider.toUpperCase()} AI`;
        if (provider === defaultProvider) {
            option.selected = true;
        }
        providerSelect.appendChild(option);
    });
    
    // Handle provider change
    providerSelect.addEventListener('change', function() {
        updateModelOptions(providers, this.value);
        updateAIStatus(this.value);
    });
    
    // Initialize with default provider
    if (defaultProvider && providers[defaultProvider]) {
        updateModelOptions(providers, defaultProvider);
        updateAIStatus(defaultProvider);
    }
}

function updateModelOptions(providers, selectedProvider) {
    const modelSelect = document.getElementById('ai_model');
    const models = providers[selectedProvider]?.models || [];
    
    // Clear existing options
    modelSelect.innerHTML = '<option value="">Auto-select best model</option>';
    
    // Add model options
    models.forEach(model => {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model;
        modelSelect.appendChild(option);
    });
}

function updateAIStatus(provider) {
    const statusIcon = document.getElementById('aiStatusIcon');
    const statusText = document.getElementById('aiStatusText');
    
    const statuses = {
        'openai': { icon: 'text-success', text: 'Ready' },
        'perplexity': { icon: 'text-info', text: 'Research Mode' },
        'deepseek': { icon: 'text-primary', text: 'Reasoning' },
        'gemini': { icon: 'text-warning', text: 'Advanced' },
        'grok': { icon: 'text-danger', text: 'Creative' },
        'claude': { icon: 'text-purple', text: 'Helpful' }
    };
    
    const status = statuses[provider] || { icon: 'text-secondary', text: 'Available' };
    statusIcon.className = `fas fa-circle ${status.icon}`;
    statusText.textContent = status.text;
}

// Show/hide voice selection based on audio generation checkbox
document.getElementById('generate_audio').addEventListener('change', function() {
    const voiceSelection = document.getElementById('voiceSelection');
    if (this.checked) {
        voiceSelection.style.display = 'block';
        // DEBUG: Check voice count when showing
        const voiceSelect = document.getElementById('voice_id');
        console.log('Voice dropdown shown. Option count:', voiceSelect.options.length);
        console.log('First 5 voices:', Array.from(voiceSelect.options).slice(0, 5).map(o => o.text));
    } else {
        voiceSelection.style.display = 'none';
    }
});

// Show/hide custom prompt section based on summary type
document.getElementById('summary_type').addEventListener('change', function() {
    const customPromptSection = document.getElementById('customPromptSection');
    const customPromptTextarea = document.getElementById('custom_prompt');
    
    if (this.value === 'custom') {
        customPromptSection.style.display = 'block';
        customPromptTextarea.required = true;
    } else {
        customPromptSection.style.display = 'none';
        customPromptTextarea.required = false;
        customPromptTextarea.value = '';
    }
});

document.getElementById('summaryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const progressDiv = document.getElementById('progressDiv');
    const statusText = document.getElementById('statusText');
    const progressBar = document.querySelector('.progress-bar');
    
    // Show progress and disable form
    submitBtn.disabled = true;
    progressDiv.style.display = 'block';
    
    const formData = new FormData(this);
    
    // Simulate progress updates
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
        
        if (progress < 30) {
            statusText.textContent = 'Extracting transcript...';
        } else if (progress < 70) {
            statusText.textContent = 'Generating summary...';
        } else {
            statusText.textContent = 'Finalizing...';
        }
    }, 1000);
    
    // Create a timeout for very long processing
    const controller = new AbortController();
    const timeoutId = setTimeout(() => {
        controller.abort();
    }, 300000); // 5 minute timeout
    
    fetch('/new', {
        method: 'POST',
        body: formData,
        signal: controller.signal
    })
    .then(response => {
        clearTimeout(timeoutId);
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        
        if (response.ok) {
            statusText.textContent = 'Complete! Redirecting...';
            setTimeout(() => {
                window.location.href = '/';
            }, 1000);
        } else {
            return response.text().then(text => {
                throw new Error(text);
            });
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        clearInterval(progressInterval);
        progressDiv.style.display = 'none';
        submitBtn.disabled = false;
        
        if (error.name === 'AbortError') {
            alert('Request timed out. The video might be too long. Please try a shorter video or try again later.');
        } else {
            alert('Error: ' + error.message);
        }
    });
});
</script>
{% endblock %}