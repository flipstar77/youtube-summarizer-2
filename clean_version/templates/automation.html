{% extends "base.html" %}

{% block title %}Automation Dashboard - YouTube Summarizer{% endblock %}

{% block content %}
<style>
    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin: -2rem -15px 2rem -15px;
        border-radius: 0 0 20px 20px;
    }
    
    .automation-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid #f0f0f0;
        transition: all 0.3s ease;
        overflow: hidden;
        margin-bottom: 2rem;
    }
    
    .automation-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    
    .automation-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }
    
    .status-running {
        background-color: #28a745;
        box-shadow: 0 0 8px rgba(40, 167, 69, 0.6);
        animation: pulse 2s infinite;
    }
    
    .status-paused {
        background-color: #ffc107;
    }
    
    .status-stopped {
        background-color: #dc3545;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 8px rgba(40, 167, 69, 0.6); }
        50% { box-shadow: 0 0 15px rgba(40, 167, 69, 0.8); }
        100% { box-shadow: 0 0 8px rgba(40, 167, 69, 0.6); }
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .job-item {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
    }
    
    .job-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
    }
    
    .activity-item {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-left: 4px solid #17a2b8;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .btn-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
    }
    
    .btn-gradient:hover {
        opacity: 0.9;
        color: white;
    }
    
    .control-panel {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .progress-ring {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: conic-gradient(#28a745 0% 75%, #f8f9fa 75% 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    .progress-ring::before {
        content: '';
        position: absolute;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: white;
    }
    
    .progress-text {
        position: relative;
        z-index: 1;
        font-weight: bold;
        font-size: 1rem;
    }
</style>

<div class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="fas fa-robot"></i> Automation Dashboard</h1>
                <p class="lead mb-0">Monitor and control automated video processing from your subscribed channels</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-flex gap-2 justify-content-end">
                    {% if status.scheduler_running %}
                        <button class="btn btn-warning" onclick="pauseAutomation()">
                            <i class="fas fa-pause"></i> Pause
                        </button>
                    {% else %}
                        <button class="btn btn-success" onclick="resumeAutomation()">
                            <i class="fas fa-play"></i> Resume
                        </button>
                    {% endif %}
                    <button class="btn btn-outline-light" onclick="forceCheck()">
                        <i class="fas fa-sync-alt"></i> Check Now
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- System Status -->
    <div class="control-panel">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h4 class="mb-3">
                    <span class="status-indicator {{ 'status-running' if status.scheduler_running else 'status-stopped' }}"></span>
                    Automation System 
                    <span class="badge {{ 'bg-success' if status.scheduler_running else 'bg-danger' }}">
                        {{ 'Running' if status.scheduler_running else 'Stopped' }}
                    </span>
                </h4>
                <p class="text-muted mb-3">
                    The automation system continuously monitors your subscribed YouTube channels for new videos 
                    and processes them according to your configured rules.
                </p>
                
                <!-- Quick Stats -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <div class="progress-ring me-3">
                                <div class="progress-text">{{ status.active_jobs_count or 0 }}</div>
                            </div>
                            <div>
                                <div class="fw-bold">Active Jobs</div>
                                <small class="text-muted">Currently processing</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="stat-number text-primary">{{ status.status_counts.get('completed', 0) }}</div>
                            <div class="stat-label">Completed Today</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="stat-number text-warning">{{ status.status_counts.get('pending', 0) }}</div>
                            <div class="stat-label">In Queue</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-grid gap-2">
                    <button class="btn btn-gradient" onclick="refreshStatus()">
                        <i class="fas fa-sync-alt"></i> Refresh Status
                    </button>
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#jobsModal">
                        <i class="fas fa-list"></i> View All Jobs
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number text-success">{{ status.status_counts.get('completed', 0) }}</div>
            <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card">
            <div class="stat-number text-primary">{{ status.status_counts.get('processing', 0) }}</div>
            <div class="stat-label">Processing</div>
        </div>
        <div class="stat-card">
            <div class="stat-number text-warning">{{ status.status_counts.get('pending', 0) }}</div>
            <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card">
            <div class="stat-number text-danger">{{ status.status_counts.get('failed', 0) }}</div>
            <div class="stat-label">Failed</div>
        </div>
    </div>

    <!-- Active Jobs -->
    {% if status.active_jobs %}
        <div class="automation-card">
            <div class="automation-header">
                <div>
                    <h4 class="mb-0">Currently Processing</h4>
                    <small class="opacity-75">{{ status.active_jobs|length }} active jobs</small>
                </div>
                <div>
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-clock"></i> Live
                    </span>
                </div>
            </div>
            <div class="card-body p-3">
                {% for job in status.active_jobs %}
                    <div class="job-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{{ job.title }}</h6>
                                <small class="text-muted">
                                    <i class="fab fa-youtube text-danger"></i> {{ job.channel }}
                                    | Started: {{ job.started_at }}
                                </small>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                <small class="text-muted">Processing...</small>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- Recent Activity -->
    <div class="automation-card">
        <div class="automation-header">
            <div>
                <h4 class="mb-0">Recent Activity</h4>
                <small class="opacity-75">Latest automation events</small>
            </div>
            <div>
                <button class="btn btn-outline-light btn-sm" onclick="refreshActivity()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
        <div class="card-body p-3">
            {% if status.recent_activity %}
                {% for activity in status.recent_activity %}
                    <div class="activity-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-bold text-capitalize">{{ activity.type.replace('_', ' ') }}</div>
                                <div class="text-muted">{{ activity.message }}</div>
                            </div>
                            <small class="text-muted">{{ activity.time }}</small>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                    <h5>No Recent Activity</h5>
                    <p class="text-muted">Automation events will appear here once the system starts processing videos.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Jobs Modal -->
<div class="modal fade" id="jobsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-list"></i> Processing Jobs</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="jobsContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading jobs...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
function pauseAutomation() {
    fetch('/automation/pause', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showNotification('success', data.message);
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('error', data.message);
            }
        })
        .catch(error => {
            showNotification('error', 'Error: ' + error.message);
        });
}

function resumeAutomation() {
    fetch('/automation/resume', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showNotification('success', data.message);
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('error', data.message);
            }
        })
        .catch(error => {
            showNotification('error', 'Error: ' + error.message);
        });
}

function forceCheck() {
    showNotification('info', 'Forcing subscription check...');
    
    fetch('/automation/force_check', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showNotification('success', data.message);
                setTimeout(() => location.reload(), 2000);
            } else {
                showNotification('error', data.message);
            }
        })
        .catch(error => {
            showNotification('error', 'Error: ' + error.message);
        });
}

function refreshStatus() {
    location.reload();
}

function refreshActivity() {
    fetch('/automation/status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update activity section
                showNotification('success', 'Status refreshed');
                setTimeout(() => location.reload(), 500);
            } else {
                showNotification('error', data.message);
            }
        })
        .catch(error => {
            showNotification('error', 'Error: ' + error.message);
        });
}

// Load jobs modal content
document.getElementById('jobsModal').addEventListener('show.bs.modal', function() {
    fetch('/automation/jobs')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displayJobsContent(data.data);
            } else {
                document.getElementById('jobsContent').innerHTML = 
                    '<div class="alert alert-danger">Error loading jobs: ' + data.message + '</div>';
            }
        })
        .catch(error => {
            document.getElementById('jobsContent').innerHTML = 
                '<div class="alert alert-danger">Error: ' + error.message + '</div>';
        });
});

function displayJobsContent(data) {
    let content = '';
    
    // Active jobs
    if (data.active_jobs && data.active_jobs.length > 0) {
        content += '<h6><i class="fas fa-play text-success"></i> Active Jobs</h6>';
        content += '<div class="row mb-4">';
        data.active_jobs.forEach(job => {
            content += `
                <div class="col-md-6 mb-2">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">${job.title}</h6>
                            <p class="card-text text-muted">${job.channel}</p>
                            <small class="text-muted">Started: ${job.started_at}</small>
                        </div>
                    </div>
                </div>
            `;
        });
        content += '</div>';
    }
    
    // Status summary
    if (data.status_counts) {
        content += '<h6><i class="fas fa-chart-bar text-info"></i> Job Statistics</h6>';
        content += '<div class="row mb-4">';
        Object.entries(data.status_counts).forEach(([status, count]) => {
            const statusColor = {
                'completed': 'success',
                'processing': 'primary', 
                'pending': 'warning',
                'failed': 'danger'
            }[status] || 'secondary';
            
            content += `
                <div class="col-md-3 mb-2">
                    <div class="text-center">
                        <div class="h4 text-${statusColor}">${count}</div>
                        <div class="text-capitalize">${status}</div>
                    </div>
                </div>
            `;
        });
        content += '</div>';
    }
    
    // Recent activity
    if (data.recent_activity && data.recent_activity.length > 0) {
        content += '<h6><i class="fas fa-history text-warning"></i> Recent Activity</h6>';
        content += '<div class="list-group">';
        data.recent_activity.forEach(activity => {
            content += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1 text-capitalize">${activity.type.replace('_', ' ')}</h6>
                            <p class="mb-1">${activity.message}</p>
                        </div>
                        <small class="text-muted">${activity.time}</small>
                    </div>
                </div>
            `;
        });
        content += '</div>';
    }
    
    if (!content) {
        content = '<div class="text-center py-4"><h5>No jobs found</h5><p class="text-muted">Jobs will appear here once automation starts processing videos.</p></div>';
    }
    
    document.getElementById('jobsContent').innerHTML = content;
}

function showNotification(type, message) {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger', 
        'info': 'alert-info',
        'warning': 'alert-warning'
    }[type] || 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Auto-refresh status every 30 seconds
setInterval(() => {
    if (!document.hidden) {
        fetch('/automation/status')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update active jobs count if changed
                    const currentCount = {{ status.active_jobs_count or 0 }};
                    const newCount = data.data.active_jobs_count || 0;
                    
                    if (newCount !== currentCount) {
                        location.reload();
                    }
                }
            })
            .catch(error => console.log('Background refresh failed:', error));
    }
}, 30000);
</script>
{% endblock %}